# 压块

新建
---------------------------------------------------------------------------

### Press
Column                              | Type      | Null | Note
------------------------------------|-----------|------|-------
`id`                                | int       | No   | 
`mix_trace_id`                      | int       | No   | 混料编号
`presser`                           | int       | No   | 压块人 Lookup
`quantity`                          | int       | No   | 
`status`                            | int       | No   | 状态。已创建(1)、已完成(9)

状态值

状态常量                | 状态值 | 值改变场景
------------------------|--------|------------
`STATUS_CREATED`        |   1    | 
`STATUS_COMPLETED`      |   9    | 终审通过时
`STATUS_DISCARDED`      |   14   | 作废

### 管理压块人

`gwRecorder` role 可以通过 `/rough-item-presser/index` 页面管理压块人。

签收
---------------------------------------------------------------------------
签收操作做以下事情：

1. 改变单据状态；
2. 更新磨料块的库存；

撤销签收
---------------------------------------------------------------------------

如果操作员签收后发现混料编号选择错误，管理员可以撤销签收操作。然后操作员可以重新修改、签收。

1. 改变单据状态；
2. 更新磨料块的库存；

异常上报
---------------------------------------------------------------------------

已压制好的磨料块在烧结之前可能存在破损、丢失等情况。需要提交一个异常上报单，审核通过后，把这些无法再装块的模块从库存中扣除。

审核通过后在 `finalAudit()` 内触发 `Lapse::apply()`. 对压块异常来说，就是更新磨料块的库存。

### PressLapse Schema

Column                              | Type      | Null | Note
------------------------------------|-----------|------|-------
`id`                                | int       | No   | 和 `lapse` 表共用主键
`mix_trace_id`                      | int       | No   | 混料追溯编号外键
`presser`                           | int       | No   | 压块人 Lookup
`quantity`                          | int       | No   | 异常数量
`status`                            | int       | No   | 状态：


作废
---------------------------------------------------------------------------
新建压块记录时会出现选错的情况。通过 `discard` 操作可纠正这类错误。

作废操作做以下事情：

- 更新 `press.status` 为“已作废”；
- 扣除对应的磨料块库存；

操作前会有一个库存前置检查，防止操作后库存为负数的情况。
- 

变更日志
--------------------------------------------------------------------------
- 2024-01-19 `Add` `press/discard` 作废操作,应对录入错误的问题；
