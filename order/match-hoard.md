# 匹配备货

> :warning: 已弃用
> 
> 实际使用中，强制业务员输入这些匹配信息作用很小。不如简化操作，仅仅在仓库取料页面
> 显示出还有库存的定向物资,提醒仓管即可。

如果业务员给之前申请过备货的客户新建一个订单，那么业务员需要手动来确定订单中的每个商品是否使用之前的某个备货来发货，这个过程就叫匹配备货。

匹配备货的意义在于：业务员可以给仓库下发一个明确的指令，协助仓库选用合适的物资发送给客户。匹配的过程就像是分发 ticket, 定向物资要想从仓库出库，必须要有这个 'ticket' 才行。


Schema
---------------------------------------------------------------------------
Column                      | Type  | Note
----------------------------|-------|-------
`goods_id`                  | int   | 
`use_hoard`                 | bool  | 1 代表使用备货，此时 `plan_item_id` 必填
`plan_item_id`              | int   |

还预留了 `quantity`, `status` 等列。

### 外键约束

- `selection.match_hoard_id` 列标记取料的类型；

流程要点
---------------------------------------------------------------------------

### 订单评审前置检查

判断一个订单是否需要匹配备货(`Order::needMatchHoard()`)会遍历所有明细记录，看是否存在至少一个需要匹配备货的 goods 记录(`Goods::needMatchHoard`()`)。必须满足下列两个条件：

1. 对应 Product.type 属于微粉、破碎料或原生料；
2. 该客户之前申请过对应产品的购买清单；

Order 两个方法：

- `needMatchHoard()`: 判断是否需要备货；
- `getIsHoardMatchingSettled()`: 备货是否已经设置过（对需要备货的，就看 goods 关联的 `match_hoard` 记录是否已创建）；

两个判断都是 true 时才能开始评审。


仓库取料(`order/pick`)时,如果发现 goods 有关联的 `match_hoard` 记录，就会显示匹配的购买清单。

仓库在专门的取料页面(`match-hoard/pick`)取料。

其它客户想使用客户备货物资的操作方式
---------------------------------------------------------------------------

其它业务员在对应 goods 下面提交 `match_hoard` 记录，换句话说，这个 `match_hoard` 记录就是使用客户备货定向物资的“门票”，仓库看到票才能取料。

Change Logs
--------------------------------------------------------------------------
- 2023-12-29 `Adj` 逻辑：订单评审前不再强制业务员匹配备货，作用不大；
