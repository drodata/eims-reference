# 终止交付

对分批交付且已开始交付的订单，系统是禁止对订单做任何修改的。在实际场景中，由于各种原因，订单可能不再交付。一直以来这里采用的都是管理员手动修改的方式实现。这里有必要将此过程规范化、流程化。

此模型在不调整 order 表结构的基础上“做加法”，承载订单终止交付的过程。

Schema
---------------------------------------------------------------------------

### OrderEnd
Column                      | Type  | Note
----------------------------|-------|-------
`id`                        | int   | 和 `order` 共用主键
`reason`                    | str   | 
`status`                    | int   | 1: 已创建、9: 已完成

### OrderEndItem

Column                      | Type  | Note
----------------------------|-------|-------
`id`                        | int   | 
`order_end_id`              | int   | 
`name`                      | str   | 品名
`specification`             | str   | 规格
`quantity`                  | int   | 终止交付数量
`goods_id`                  | int   | 注意：这里没有外键约束（goods 记录可能会删除）


逻辑要点
---------------------------------------------------------------------------

此按钮仅在订单状态是“交付中”时才会出现,保存表单时，会对相关记录合法性进行检查，并通过 `order_end_item.specification` 显示出来，主要包含如下情况：

1. 各 goods 下面不得存在“活动的”取料记录,即尚未关联交付单的取料记录；
2. 如果一个 goods 没有任何取料记录，则意味着此记录将会被删除，这时需要以下额外检查，防止出现外键约束错误：
    - goods 上面不能有最终检测结果;
    - 不能有订单备货申请记录；

- 不支持用户自定义未交付数量。当前货物还未交付的数量，即要取消的数量；
- goods 表根据之前是否有交付记录分为两种情况：之前交付过，则仅调整数量，否则删除 goods 记录；
    - `preparation.goods_id` 已取消外键约束(#22)，因此删除 goods 并不会删除 preparation;
- `order_end_item.specification` 有一个额外验证：确保将要删除的记录上没有最终检验结果；
- 确定执行(`OrderEnd::apply()`)后，触发各个 handler 做如下事情：
    - 更新订单的状态和金额两列；
    - 更新订单关联的余额表数量；

评审
---------------------------------------------------------------------------
评审顺序：业务员、销售经理、仓库、生产主管。
